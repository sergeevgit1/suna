services:
  api:
    image: ghcr.io/suna-ai/suna-backend:latest
    platform: linux/amd64
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "8000:8000"
    env_file:
      - .env
    volumes:
      - .:/app
      - /app/.venv
      - ./logs:/app/logs
    restart: unless-stopped
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - app-network
    environment:
      - REDIS_HOST=${REDIS_HOST:-redis}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
      - REDIS_SSL=${REDIS_SSL:-false}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      # Базовые режимы
      - ENV_MODE=${ENV_MODE:-production}
      # Supabase (REQUIRED)
      - SUPABASE_URL=${SUPABASE_URL:-}
      - SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY:-}
      - SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY:-}
      - SUPABASE_JWT_SECRET=${SUPABASE_JWT_SECRET:-}
      # LLM providers (укажите хотя бы один ключ)
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - GROQ_API_KEY=${GROQ_API_KEY:-}
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY:-}
      - GEMINI_API_KEY=${GEMINI_API_KEY:-}
      - XAI_API_KEY=${XAI_API_KEY:-}
      # AWS Bedrock
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID:-}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY:-}
      - AWS_REGION_NAME=${AWS_REGION_NAME:-}
      # OpenAI-compatible / OpenRouter
      - OPENAI_COMPATIBLE_API_KEY=${OPENAI_COMPATIBLE_API_KEY:-}
      - OPENAI_COMPATIBLE_API_BASE=${OPENAI_COMPATIBLE_API_BASE:-}
      - OPENROUTER_API_BASE=${OPENROUTER_API_BASE:-https://openrouter.ai/api/v1}
      - OR_SITE_URL=${OR_SITE_URL:-https://kortix.ai}
      - OR_APP_NAME=${OR_APP_NAME:-Kortix AI}
      # Data / Search
      - RAPID_API_KEY=${RAPID_API_KEY:-}
      - TAVILY_API_KEY=${TAVILY_API_KEY:-}
      - SERPER_API_KEY=${SERPER_API_KEY:-}
      - CLOUDFLARE_API_TOKEN=${CLOUDFLARE_API_TOKEN:-}
      # Web scrape
      - FIRECRAWL_API_KEY=${FIRECRAWL_API_KEY:-}
      - FIRECRAWL_URL=${FIRECRAWL_URL:-}
      - EXA_API_KEY=${EXA_API_KEY:-}
      - SEMANTIC_SCHOLAR_API_KEY=${SEMANTIC_SCHOLAR_API_KEY:-}
      # Agent Sandbox (Daytona)
      - DAYTONA_API_KEY=${DAYTONA_API_KEY:-}
      - DAYTONA_SERVER_URL=${DAYTONA_SERVER_URL:-}
      - DAYTONA_TARGET=${DAYTONA_TARGET:-}
      # Observability
      - LANGFUSE_PUBLIC_KEY=${LANGFUSE_PUBLIC_KEY:-}
      - LANGFUSE_SECRET_KEY=${LANGFUSE_SECRET_KEY:-}
      - LANGFUSE_HOST=${LANGFUSE_HOST:-https://cloud.langfuse.com}
      # Admin
      - KORTIX_ADMIN_API_KEY=${KORTIX_ADMIN_API_KEY:-}
      # API Keys system
      - API_KEY_SECRET=${API_KEY_SECRET:-}
      - API_KEY_LAST_USED_THROTTLE_SECONDS=${API_KEY_LAST_USED_THROTTLE_SECONDS:-900}
      # MCP / Composio
      - MCP_CREDENTIAL_ENCRYPTION_KEY=${MCP_CREDENTIAL_ENCRYPTION_KEY:-}
      - COMPOSIO_API_KEY=${COMPOSIO_API_KEY:-}
      - COMPOSIO_WEBHOOK_SECRET=${COMPOSIO_WEBHOOK_SECRET:-}
      - COMPOSIO_API_BASE=${COMPOSIO_API_BASE:-}
      # Webhooks
      - WEBHOOK_BASE_URL=${WEBHOOK_BASE_URL:-}
      - TRIGGER_WEBHOOK_SECRET=${TRIGGER_WEBHOOK_SECRET:-}
      # Billing (Stripe)
      - STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY:-}
      - STRIPE_WEBHOOK_SECRET=${STRIPE_WEBHOOK_SECRET:-}
      - STRIPE_DEFAULT_PLAN_ID=${STRIPE_DEFAULT_PLAN_ID:-}
      - STRIPE_DEFAULT_TRIAL_DAYS=${STRIPE_DEFAULT_TRIAL_DAYS:-14}
      # Integrations / Other
      - ZENDESK_AUTH_CONFIG=${ZENDESK_AUTH_CONFIG:-}
      - CHUNKR_API_KEY=${CHUNKR_API_KEY:-}
      # CORS / Frontend URL
      - FRONTEND_URL_ENV=${FRONTEND_URL_ENV:-}
      - CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS:-}
      - FRONTEND_ORIGIN=${FRONTEND_ORIGIN:-}
      - ALLOW_ORIGIN_REGEX=${ALLOW_ORIGIN_REGEX:-}
      # Параллелизм (опционально)
      - _MAX_PARALLEL_AGENT_RUNS_ENV=${_MAX_PARALLEL_AGENT_RUNS_ENV:-}
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  worker:
    image: ghcr.io/suna-ai/suna-backend:latest
    platform: linux/amd64
    build:
      context: .
      dockerfile: Dockerfile
    command: uv run dramatiq --skip-logging --processes 4 --threads 4 run_agent_background
    env_file:
      - .env
    volumes:
      - .:/app
      - /app/.venv
      - ./worker-logs:/app/logs
    restart: unless-stopped
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - app-network
    environment:
      - REDIS_HOST=${REDIS_HOST:-redis}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
      - REDIS_SSL=${REDIS_SSL:-false}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      # Базовые режимы
      - ENV_MODE=${ENV_MODE:-production}
      # Supabase (REQUIRED)
      - SUPABASE_URL=${SUPABASE_URL:-}
      - SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY:-}
      - SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY:-}
      - SUPABASE_JWT_SECRET=${SUPABASE_JWT_SECRET:-}
      # LLM providers (укажите хотя бы один ключ)
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - GROQ_API_KEY=${GROQ_API_KEY:-}
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY:-}
      - GEMINI_API_KEY=${GEMINI_API_KEY:-}
      - XAI_API_KEY=${XAI_API_KEY:-}
      # AWS Bedrock
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID:-}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY:-}
      - AWS_REGION_NAME=${AWS_REGION_NAME:-}
      # OpenAI-compatible / OpenRouter
      - OPENAI_COMPATIBLE_API_KEY=${OPENAI_COMPATIBLE_API_KEY:-}
      - OPENAI_COMPATIBLE_API_BASE=${OPENAI_COMPATIBLE_API_BASE:-}
      - OPENROUTER_API_BASE=${OPENROUTER_API_BASE:-https://openrouter.ai/api/v1}
      - OR_SITE_URL=${OR_SITE_URL:-https://kortix.ai}
      - OR_APP_NAME=${OR_APP_NAME:-Kortix AI}
      # Data / Search
      - RAPID_API_KEY=${RAPID_API_KEY:-}
      - TAVILY_API_KEY=${TAVILY_API_KEY:-}
      - SERPER_API_KEY=${SERPER_API_KEY:-}
      - CLOUDFLARE_API_TOKEN=${CLOUDFLARE_API_TOKEN:-}
      # Web scrape
      - FIRECRAWL_API_KEY=${FIRECRAWL_API_KEY:-}
      - FIRECRAWL_URL=${FIRECRAWL_URL:-}
      - EXA_API_KEY=${EXA_API_KEY:-}
      - SEMANTIC_SCHOLAR_API_KEY=${SEMANTIC_SCHOLAR_API_KEY:-}
      # Agent Sandbox (Daytona)
      - DAYTONA_API_KEY=${DAYTONA_API_KEY:-}
      - DAYTONA_SERVER_URL=${DAYTONA_SERVER_URL:-}
      - DAYTONA_TARGET=${DAYTONA_TARGET:-}
      # Observability
      - LANGFUSE_PUBLIC_KEY=${LANGFUSE_PUBLIC_KEY:-}
      - LANGFUSE_SECRET_KEY=${LANGFUSE_SECRET_KEY:-}
      - LANGFUSE_HOST=${LANGFUSE_HOST:-https://cloud.langfuse.com}
      # Admin
      - KORTIX_ADMIN_API_KEY=${KORTIX_ADMIN_API_KEY:-}
      # API Keys system
      - API_KEY_SECRET=${API_KEY_SECRET:-}
      - API_KEY_LAST_USED_THROTTLE_SECONDS=${API_KEY_LAST_USED_THROTTLE_SECONDS:-900}
      # MCP / Composio
      - MCP_CREDENTIAL_ENCRYPTION_KEY=${MCP_CREDENTIAL_ENCRYPTION_KEY:-}
      - COMPOSIO_API_KEY=${COMPOSIO_API_KEY:-}
      - COMPOSIO_WEBHOOK_SECRET=${COMPOSIO_WEBHOOK_SECRET:-}
      - COMPOSIO_API_BASE=${COMPOSIO_API_BASE:-}
      # Webhooks
      - WEBHOOK_BASE_URL=${WEBHOOK_BASE_URL:-}
      - TRIGGER_WEBHOOK_SECRET=${TRIGGER_WEBHOOK_SECRET:-}
      # Billing (Stripe)
      - STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY:-}
      - STRIPE_WEBHOOK_SECRET=${STRIPE_WEBHOOK_SECRET:-}
      - STRIPE_DEFAULT_PLAN_ID=${STRIPE_DEFAULT_PLAN_ID:-}
      - STRIPE_DEFAULT_TRIAL_DAYS=${STRIPE_DEFAULT_TRIAL_DAYS:-14}
      # Integrations / Other
      - ZENDESK_AUTH_CONFIG=${ZENDESK_AUTH_CONFIG:-}
      - CHUNKR_API_KEY=${CHUNKR_API_KEY:-}
      # CORS / Frontend URL
      - FRONTEND_URL_ENV=${FRONTEND_URL_ENV:-}
      - CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS:-}
      - FRONTEND_ORIGIN=${FRONTEND_ORIGIN:-}
      - ALLOW_ORIGIN_REGEX=${ALLOW_ORIGIN_REGEX:-}
      # Параллелизм (опционально)
      - _MAX_PARALLEL_AGENT_RUNS_ENV=${_MAX_PARALLEL_AGENT_RUNS_ENV:-}
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    healthcheck:
      test: ["CMD", "uv", "run", "worker_health.py"]
      timeout: 20s
      interval: 30s
      start_period: 40s

  redis:
    image: redis:8-alpine
    ports:
      - "127.0.0.1:6379:6379"
    volumes:
      - redis_data:/data
      - ./services/docker/redis.conf:/usr/local/etc/redis/redis.conf:ro
    restart: unless-stopped
    networks:
      - app-network
    command: redis-server /usr/local/etc/redis/redis.conf --appendonly yes --bind 0.0.0.0 --protected-mode no --maxmemory 8gb --maxmemory-policy allkeys-lru
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

networks:
  app-network:
    driver: bridge

volumes:
  redis_data:
