# ============================================================================
# SUNA DOCKER COMPOSE - DOKPLOY DEPLOYMENT
# ============================================================================
# Этот файл предназначен для деплоя через Dokploy.
# Все переменные окружения берутся из Dokploy Environments и
# прокидываются в сервисы. Файлы .env и .env.local не используются.
# Используйте только этот файл в Dokploy (не объединяйте с локальным compose).
# ============================================================================

services:
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
      - ./backend/services/docker/redis.conf:/usr/local/etc/redis/redis.conf:ro
    command: redis-server /usr/local/etc/redis/redis.conf --save 60 1 --loglevel warning
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3

  backend:
    image: ghcr.io/suna-ai/suna-backend:latest
    platform: linux/amd64
    build:
      context: ./backend
      dockerfile: Dockerfile
    ports:
      - "8000:8000"
    environment:
      # Базовые режимы
      ENV_MODE: ${ENV_MODE}
      # Redis (внутренний хост контейнера)
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-}
      REDIS_SSL: ${REDIS_SSL:-false}
      # Supabase (REQUIRED)
      SUPABASE_URL: ${SUPABASE_URL}
      SUPABASE_ANON_KEY: ${SUPABASE_ANON_KEY}
      SUPABASE_SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_ROLE_KEY}
      # LLM providers
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      GROQ_API_KEY: ${GROQ_API_KEY:-}
      OPENROUTER_API_KEY: ${OPENROUTER_API_KEY:-}
      GEMINI_API_KEY: ${GEMINI_API_KEY:-}
      XAI_API_KEY: ${XAI_API_KEY:-}
      # AWS Bedrock
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID:-}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY:-}
      AWS_REGION_NAME: ${AWS_REGION_NAME:-}
      AWS_REGION: ${AWS_REGION:-}
      AWS_DEFAULT_REGION: ${AWS_DEFAULT_REGION:-}
      AWS_BEARER_TOKEN_BEDROCK: ${AWS_BEARER_TOKEN_BEDROCK:-}
      # OpenAI-compatible
      OPENAI_COMPATIBLE_API_KEY: ${OPENAI_COMPATIBLE_API_KEY:-}
      OPENAI_COMPATIBLE_API_BASE: ${OPENAI_COMPATIBLE_API_BASE:-}
      # Data/Search (REQUIRED)
      RAPID_API_KEY: ${RAPID_API_KEY}
      TAVILY_API_KEY: ${TAVILY_API_KEY}
      # Web scrape (REQUIRED)
      FIRECRAWL_API_KEY: ${FIRECRAWL_API_KEY}
      FIRECRAWL_URL: ${FIRECRAWL_URL:-}
      # Agent Sandbox (Daytona)
      DAYTONA_API_KEY: ${DAYTONA_API_KEY:-}
      DAYTONA_SERVER_URL: ${DAYTONA_SERVER_URL:-}
      DAYTONA_TARGET: ${DAYTONA_TARGET:-}
      # Security & Webhooks
      MCP_CREDENTIAL_ENCRYPTION_KEY: ${MCP_CREDENTIAL_ENCRYPTION_KEY:-}
      TRIGGER_WEBHOOK_SECRET: ${TRIGGER_WEBHOOK_SECRET:-}
      # Observability
      LANGFUSE_PUBLIC_KEY: ${LANGFUSE_PUBLIC_KEY:-}
      LANGFUSE_SECRET_KEY: ${LANGFUSE_SECRET_KEY:-}
      LANGFUSE_HOST: ${LANGFUSE_HOST:-}
      # Billing
      STRIPE_SECRET_KEY: ${STRIPE_SECRET_KEY:-}
      STRIPE_WEBHOOK_SECRET: ${STRIPE_WEBHOOK_SECRET:-}
      STRIPE_DEFAULT_PLAN_ID: ${STRIPE_DEFAULT_PLAN_ID:-}
      STRIPE_DEFAULT_TRIAL_DAYS: ${STRIPE_DEFAULT_TRIAL_DAYS:-14}
      # Admin
      KORTIX_ADMIN_API_KEY: ${KORTIX_ADMIN_API_KEY:-}
      # Integrations
      COMPOSIO_API_KEY: ${COMPOSIO_API_KEY:-}
      COMPOSIO_WEBHOOK_SECRET: ${COMPOSIO_WEBHOOK_SECRET:-}
      COMPOSIO_API_BASE: ${COMPOSIO_API_BASE:-}
      # Google integrations
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID:-}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET:-}
      GOOGLE_REDIRECT_URI: ${GOOGLE_REDIRECT_URI:-}
      # Other
      ZENDESK_AUTH_CONFIG: ${ZENDESK_AUTH_CONFIG:-}
      EXA_API_KEY: ${EXA_API_KEY:-}
      CHUNKR_API_KEY: ${CHUNKR_API_KEY:-}
      # CORS (новые переменные из backend/.env.example)
      CORS_ALLOWED_ORIGINS: ${CORS_ALLOWED_ORIGINS:-}
      FRONTEND_ORIGIN: ${FRONTEND_ORIGIN:-}
      ALLOW_ORIGIN_REGEX: ${ALLOW_ORIGIN_REGEX:-}
    depends_on:
      redis:
        condition: service_healthy
      worker:
        condition: service_started

  worker:
    image: ghcr.io/suna-ai/suna-backend:latest
    platform: linux/amd64
    build:
      context: ./backend
      dockerfile: Dockerfile
    command: uv run dramatiq --skip-logging --processes 4 --threads 4 run_agent_background
    environment:
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-}
      REDIS_SSL: ${REDIS_SSL:-false}
      # Те же бэкенд-переменные, если воркеру они нужны
      ENV_MODE: ${ENV_MODE}
      SUPABASE_URL: ${SUPABASE_URL}
      SUPABASE_ANON_KEY: ${SUPABASE_ANON_KEY}
      SUPABASE_SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_ROLE_KEY}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      GROQ_API_KEY: ${GROQ_API_KEY:-}
      OPENROUTER_API_KEY: ${OPENROUTER_API_KEY:-}
      GEMINI_API_KEY: ${GEMINI_API_KEY:-}
      XAI_API_KEY: ${XAI_API_KEY:-}
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID:-}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY:-}
      AWS_REGION_NAME: ${AWS_REGION_NAME:-}
      AWS_REGION: ${AWS_REGION:-}
      AWS_DEFAULT_REGION: ${AWS_DEFAULT_REGION:-}
      AWS_BEARER_TOKEN_BEDROCK: ${AWS_BEARER_TOKEN_BEDROCK:-}
      OPENAI_COMPATIBLE_API_KEY: ${OPENAI_COMPATIBLE_API_KEY:-}
      OPENAI_COMPATIBLE_API_BASE: ${OPENAI_COMPATIBLE_API_BASE:-}
      RAPID_API_KEY: ${RAPID_API_KEY}
      TAVILY_API_KEY: ${TAVILY_API_KEY}
      FIRECRAWL_API_KEY: ${FIRECRAWL_API_KEY}
      FIRECRAWL_URL: ${FIRECRAWL_URL:-}
      DAYTONA_API_KEY: ${DAYTONA_API_KEY:-}
      DAYTONA_SERVER_URL: ${DAYTONA_SERVER_URL:-}
      DAYTONA_TARGET: ${DAYTONA_TARGET:-}
      MCP_CREDENTIAL_ENCRYPTION_KEY: ${MCP_CREDENTIAL_ENCRYPTION_KEY:-}
      TRIGGER_WEBHOOK_SECRET: ${TRIGGER_WEBHOOK_SECRET:-}
      LANGFUSE_PUBLIC_KEY: ${LANGFUSE_PUBLIC_KEY:-}
      LANGFUSE_SECRET_KEY: ${LANGFUSE_SECRET_KEY:-}
      LANGFUSE_HOST: ${LANGFUSE_HOST:-}
      STRIPE_SECRET_KEY: ${STRIPE_SECRET_KEY:-}
      STRIPE_WEBHOOK_SECRET: ${STRIPE_WEBHOOK_SECRET:-}
      STRIPE_DEFAULT_PLAN_ID: ${STRIPE_DEFAULT_PLAN_ID:-}
      STRIPE_DEFAULT_TRIAL_DAYS: ${STRIPE_DEFAULT_TRIAL_DAYS:-14}
      KORTIX_ADMIN_API_KEY: ${KORTIX_ADMIN_API_KEY:-}
      COMPOSIO_API_KEY: ${COMPOSIO_API_KEY:-}
      COMPOSIO_WEBHOOK_SECRET: ${COMPOSIO_WEBHOOK_SECRET:-}
      COMPOSIO_API_BASE: ${COMPOSIO_API_BASE:-}
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID:-}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET:-}
      GOOGLE_REDIRECT_URI: ${GOOGLE_REDIRECT_URI:-}
      ZENDESK_AUTH_CONFIG: ${ZENDESK_AUTH_CONFIG:-}
      EXA_API_KEY: ${EXA_API_KEY:-}
      CHUNKR_API_KEY: ${CHUNKR_API_KEY:-}
    depends_on:
      redis:
        condition: service_healthy

  frontend:
    init: true
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        NEXT_PUBLIC_ENV_MODE: ${NEXT_PUBLIC_ENV_MODE}
        NEXT_PUBLIC_SUPABASE_URL: ${NEXT_PUBLIC_SUPABASE_URL}
        NEXT_PUBLIC_SUPABASE_ANON_KEY: ${NEXT_PUBLIC_SUPABASE_ANON_KEY}
        NEXT_PUBLIC_BACKEND_URL: ${NEXT_PUBLIC_BACKEND_URL}
        NEXT_PUBLIC_URL: ${NEXT_PUBLIC_URL}
        NEXT_PUBLIC_GOOGLE_CLIENT_ID: ${NEXT_PUBLIC_GOOGLE_CLIENT_ID}
        NEXT_PUBLIC_POSTHOG_KEY: ${NEXT_PUBLIC_POSTHOG_KEY}
        KORTIX_ADMIN_API_KEY: ${KORTIX_ADMIN_API_KEY}
        EDGE_CONFIG: ${EDGE_CONFIG}
    environment:
      NEXT_PUBLIC_ENV_MODE: ${NEXT_PUBLIC_ENV_MODE}
      NEXT_PUBLIC_SUPABASE_URL: ${NEXT_PUBLIC_SUPABASE_URL}
      NEXT_PUBLIC_SUPABASE_ANON_KEY: ${NEXT_PUBLIC_SUPABASE_ANON_KEY}
      NEXT_PUBLIC_BACKEND_URL: ${NEXT_PUBLIC_BACKEND_URL}
      NEXT_PUBLIC_URL: ${NEXT_PUBLIC_URL}
      NEXT_PUBLIC_GOOGLE_CLIENT_ID: ${NEXT_PUBLIC_GOOGLE_CLIENT_ID}
      NEXT_PUBLIC_POSTHOG_KEY: ${NEXT_PUBLIC_POSTHOG_KEY}
      KORTIX_ADMIN_API_KEY: ${KORTIX_ADMIN_API_KEY}
      EDGE_CONFIG: ${EDGE_CONFIG}
    ports:
      - "3000:3000"
    depends_on:
      - backend

volumes:
  redis_data:
